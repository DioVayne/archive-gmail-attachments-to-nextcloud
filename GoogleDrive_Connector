/**
 * ===================================================================================
 * STORAGE PROVIDER: Google Drive
 * ===================================================================================
 * Contains all logic specific to interacting with Google Drive.
 * This is an example of how easily a new provider can be added.
 */

/**
 * The 'provider' object expected by the `code.gs` logic.
 */
const GoogleDriveProvider = {
  /**
   * Stores credentials. For Google Drive, this is not needed,
   * because authentication is automatic via the script's 'scopes'.
   */
  initialize: function() {
    Logger.log('Google Drive provider selected. No credentials need to be stored.');
    // Check if the folder exists
    try {
      DriveApp.getFolderById(CONFIG.ROOT_FOLDER_ID);
    } catch (e) {
      throw new Error(`Google Drive folder with ID "${CONFIG.ROOT_FOLDER_ID}" not found. Check Config.gs.`);
    }
  },

  /**
   * Uploads a file to the specified Google Drive folder.
   * @param {string} fileName The unique filename.
   * @param {GmailApp.Attachment} blob The file blob.
   * @param {object} info Extra info (unused).
   * @returns {string} The File ID of the new file.
   */
  uploadFile: function(fileName, blob, info) {
    try {
      const folder = DriveApp.getFolderById(CONFIG.ROOT_FOLDER_ID);
      const file = folder.createFile(blob); // Upload the file
      file.setName(fileName); // Rename it to our unique name
      return file.getId(); // Return the ID
    } catch (e) {
      throw new Error(`Google Drive Upload failed: ${e.message}`);
    }
  },

  /**
   * Creates an 'anyone with the link' share link.
   * @param {string} fileName The filename (unused, we need the ID).
   * @param {string} uploadResult The File ID from the uploadFile step.
   * @returns {string} The direct download link.
   */
  createShareLink: function(fileName, uploadResult) {
    try {
      const fileId = uploadResult; // This is the File ID
      const file = DriveApp.getFileById(fileId);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

      // We want a *direct download* link, not the viewer.
      // Format: https://drive.google.com/uc?export=download&id=FILE_ID
      return `https://drive.google.com/uc?export=download&id=${fileId}`;
    } catch (e) {
      throw new Error(`Google Drive share link failed: ${e.message}`);
    }
  },

  /**
   * Creates a fallback link to the Google Drive UI.
   * @param {string} fileName The filename (unused).
   * @param {string} uploadResult The File ID.
   * @returns {string} The full UI URL.
   */
  createUiLink: function(fileName, uploadResult) {
    const fileId = uploadResult;
    try {
      return DriveApp.getFileById(fileId).getUrl();
    } catch (e) {
      return `https://drive.google.com/drive/files/${fileId}`; // Fallback
    }
  }
};