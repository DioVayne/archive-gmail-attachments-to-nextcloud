/**
 * ===================================================================================
 * STORAGE PROVIDER: Nextcloud
 * ===================================================================================
 * Contains all logic specific to interacting with Nextcloud via WebDAV and OCS.
 */

/**
 * The 'provider' object expected by the `code.gs` logic.
 * It bundles the standard functions.
 */
const NextcloudProvider = {
  /**
   * Stores the sensitive Nextcloud credentials in PropertiesService.
   * Called by `setupCredentials()` in Config.gs.
   */
  initialize: function() {
    const props = PropertiesService.getScriptProperties();
    props.setProperties({
      'NEXTCLOUD_USER': USER_CONFIG_SENSITIVE.NEXTCLOUD_USER,
      'NEXTCLOUD_APP_PASSWORD': USER_CONFIG_SENSITIVE.NEXTCLOUD_APP_PASSWORD
    });
  },

  /**
   * Uploads a file to Nextcloud via WebDAV.
   * @param {string} fileName The unique filename.
   * @param {GmailApp.Attachment} blob The file blob.
   * @param {object} info Extra info (unused by Nextcloud, but required by interface).
   * @returns {string} The WebDAV URL of the uploaded file.
   */
  uploadFile: function(fileName, blob, info) {
    const filePath = `${CONFIG.ROOT_PATH}/${fileName}`;
    const url = nextcloud_webdavUrl_(filePath);

    const resp = UrlFetchApp.fetch(url, {
      method: 'put',
      headers: nextcloud_basicAuthHeader_(),
      payload: blob.getBytes(),
      contentType: blob.getContentType() || 'application/octet-stream',
      muteHttpExceptions: true
    });

    const code = resp.getResponseCode();
    if (code < 200 || code >= 300) {
      const technicalError = `Nextcloud Upload failed: ${code} ${resp.getContentText()}`;
      throw createUserFriendlyError_(technicalError, `Uploading file: ${fileName}`);
    }
    return url; // Returns the WebDAV URL
  },

  /**
   * Creates a (public) share link via the Nextcloud OCS API.
   * @param {string} fileName The filename.
   * @param {string} uploadResult The WebDAV URL (unused, path is recalculated).
   * @returns {string} The direct download link.
   */
  createShareLink: function(fileName, uploadResult) {
    if (!CONFIG.USE_PUBLIC_LINKS) {
      return this.createUiLink(fileName, uploadResult);
    }
    
    const filePath = `${CONFIG.ROOT_PATH}/${fileName}`;
    const fullPath = '/' + filePath.replace(/^\//, '');
    const url = CONFIG.BASE_URL + '/ocs/v2.php/apps/files_sharing/api/v1/shares';
    const payload = { path: fullPath, shareType: '3', permissions: '1' }; // 3 = public, 1 = read

    if (CONFIG.PUBLIC_LINK_EXPIRE_DAYS > 0) {
      const until = new Date(Date.now() + CONFIG.PUBLIC_LINK_EXPIRE_DAYS * 86400 * 1000);
      payload.expireDate = Utilities.formatDate(until, 'UTC', 'yyyy-MM-dd');
    }
    if (CONFIG.PUBLIC_LINK_PASSWORD) {
      payload.password = CONFIG.PUBLIC_LINK_PASSWORD;
    }

    const headers = Object.assign(nextcloud_basicAuthHeader_(), { 'OCS-APIRequest': 'true', 'Accept': 'application/json' });
    const resp = UrlFetchApp.fetch(url, { method: 'post', headers: headers, payload: payload, muteHttpExceptions: true });
    const code = resp.getResponseCode();
    const respText = resp.getContentText();
    if (code < 200 || code >= 300) {
      const technicalError = `Nextcloud OCS share failed: ${code} ${respText}`;
      throw createUserFriendlyError_(technicalError, `Creating share link for: ${fileName}`);
    }

    try {
      const data = JSON.parse(respText);
      if (data && data.ocs && data.ocs.data && data.ocs.data.url) {
        const shareUrl = data.ocs.data.url;
        return shareUrl.endsWith('/') ? shareUrl + 'download' : shareUrl + '';
      }
    } catch (e) {
      Logger.log('Error parsing OCS JSON response: %s', e.message);
      Logger.log('Response was: %s', respText);
    }
    throw new Error('OCS share succeeded, but could not find URL in JSON response.');
  },

  /**
   * Creates a fallback link to the Nextcloud UI.
   * @param {string} fileName The filename.
   * @returns {string} The full UI URL.
   */
  createUiLink: function(fileName) {
    const dirParam = encodeURIComponent('/' + CONFIG.ROOT_PATH.replace(/^\//, ''));
    const fileParam = encodeURIComponent(fileName);
    return `${CONFIG.BASE_URL}/index.php/apps/files/?dir=${dirParam}&openfile=${fileParam}`;
  }
};


// ===================================================================================
// PRIVATE HELPER FUNCTIONS (Nextcloud)
// ===================================================================================

/**
 * Builds the full WebDAV URL.
 * @param {string} path The file path.
 * @returns {string} The full WebDAV URL.
 * @private
 */
function nextcloud_webdavUrl_(path) {
  const clean = path.replace(/^\/*/, '');
  // Build path segments correctly
  const encodedPath = clean.split('/').map(encodeURIComponent).join('/');
  return CONFIG.BASE_WEBDAV + '/' + encodedPath;
}

/**
 * Creates the 'Basic Auth' header from PropertiesService.
 * @returns {object} The Authorization header object.
 * @private
 */
function nextcloud_basicAuthHeader_() {
  const props = PropertiesService.getScriptProperties();
  const user = props.getProperty('NEXTCLOUD_USER');
  const password = props.getProperty('NEXTCLOUD_APP_PASSWORD');

  if (!user || !password) {
    throw new Error('Nextcloud credentials not found in PropertiesService. Run setupCredentials() first.');
  }

  const token = Utilities.base64Encode(user + ':' + password);
  return { 'Authorization': 'Basic ' + token };
}